FROM ubuntu:20.04

ARG SCARB_VERSION
ARG USERNAME=appuser
ARG USER_UID=1001
ARG USER_GID=1001

ENV DEBIAN_FRONTEND=noninteractive
ENV DEBCONF_NONINTERACTIVE_SEEN=true
ENV SCARB_VERSION=${SCARB_VERSION}
RUN apt-get clean

RUN apt-get update
RUN apt-get install -y --no-install-recommends curl \
    git \
    cmake \
    build-essential \
    gcc \
    apt-transport-https \
    software-properties-common \
    wget \
    pkg-config \
    libssl-dev

# Installing grafana agent
RUN mkdir -p /etc/apt/keyrings/
RUN wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | tee /etc/apt/keyrings/grafana.gpg > /dev/null
RUN echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | tee -a /etc/apt/sources.list.d/grafana.list

RUN apt-get update
RUN apt-get install grafana-agent-flow


RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        automake \
        autoconf \
        libreadline-dev && \
    rm -rf /var/lib/apt/lists/*

# ----------------------------------------------------------------------------
# USE NON_ROOT USER
# ----------------------------------------------------------------------------
RUN groupadd --gid $USER_GID $USERNAME \
  && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME -s /bin/bash
USER $USERNAME
WORKDIR /home/$USERNAME

# ----------------------------------------------------------------------------
# ASDF INSTALLATION
# ----------------------------------------------------------------------------
ENV ASDF_VERSION="v0.13.1"
RUN git clone --branch "${ASDF_VERSION}" https://github.com/asdf-vm/asdf.git ~/.asdf

RUN echo '. $HOME/.asdf/asdf.sh' >> ~/.bashrc \
  && echo '. $HOME/.asdf/completions/asdf.bash' >> ~/.bashrc \
  && echo 'export PATH="$HOME/.asdf/bin:$HOME/.asdf/shims:$PATH"' >> ~/.bashrc
ENV PATH="/home/$USERNAME/.asdf/bin:/home/$USERNAME/.asdf/shims:${PATH}"

# ENV ASDF_DIR="~/.asdf"
# ENV PATH="${ASDF_DIR}/bin:${ASDF_DIR}/shims:${PATH}"
# RUN echo ". ~/.asdf/asdf.sh" >> ${APP_HOMEDIR}/.bashrc && \
#     echo ". ~/.asdf/completions/asdf.bash" >> ${APP_HOMEDIR}/.bashrc
# # RUN bash -c "source ~/.bashrc && asdf --version"

# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# INSTALL SCARB USING ASDF
# ----------------------------------------------------------------------------
RUN asdf plugin add scarb
RUN asdf install scarb ${SCARB_VERSION}
RUN asdf global scarb ${SCARB_VERSION}
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# INSTALL UNIVERSAL SIERRA COMPILER
# ----------------------------------------------------------------------------
RUN curl -L https://raw.githubusercontent.com/software-mansion/universal-sierra-compiler/master/scripts/install.sh | bash

ENV PATH="/home/$USERNAME/.local/bin:${PATH}"
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# INSTALL FOUNDRY USING ASDF
# ----------------------------------------------------------------------------
RUN asdf plugin add starknet-foundry
RUN asdf install starknet-foundry latest
RUN asdf global starknet-foundry latest
# ----------------------------------------------------------------------------

# WORKDIR ${APP_HOMEDIR}
# SHELL ["/bin/bash", "-lc"]
# RUN chown -R appuser:appuser /opt/app

# ----------------------------------------------------------------------------
# INSTALL RUST
# ----------------------------------------------------------------------------
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain stable -y
RUN whoami
ENV PATH="~/.cargo/bin:${PATH}"

# # ----------------------------------------------------------------------------

# copy Remix plugin source
COPY --chown=appuser:appuser . /home/$USERNAME
RUN git config --global --add safe.directory /home/$USERNAME
RUN git submodule update --init

# Build the API service
WORKDIR /home/$USERNAME/api
SHELL ["/bin/bash", "-lc"]
RUN cargo build --release
RUN chmod +x ./docker_run.sh
EXPOSE 8000
ENTRYPOINT [ "./docker_run.sh" ]
